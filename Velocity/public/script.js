for(var __awaiter=this&&this.__awaiter||function(t,o,s,l){return new(s=s||Promise)(function(i,e){function r(t){try{n(l.next(t))}catch(t){e(t)}}function a(t){try{n(l.throw(t))}catch(t){e(t)}}function n(t){var e;t.done?i(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(r,a)}n((l=l.apply(t,o||[])).next())})},__generator=this&&this.__generator||function(i,r){var a,n,o,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,n&&(o=2&e[0]?n.return:e[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,e[1])).done)return o;switch(n=0,(e=o?[2&e[0],o.value]:e)[0]){case 0:case 1:o=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,n=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(o=0<(o=s.trys).length&&o[o.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!o||e[1]>o[0]&&e[1]<o[3])){s.label=e[1];break}if(6===e[0]&&s.label<o[1]){s.label=o[1],o=e;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(e);break}o[2]&&s.ops.pop(),s.trys.pop();continue}e=r.call(i,s)}catch(t){e=[6,t],n=0}finally{a=o=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}},cv=document.getElementById("cpxCanvas"),cx=cv.getContext("2d"),WIDTH=cv.width,HEIGHT=cv.height,textWidth=document.getElementById("width"),textHeight=document.getElementById("height"),checkImprove=document.getElementById("improve"),Address=function(){function t(t,e){this.set(t,e)}return t.prototype.set=function(t,e){this.i=t,this.j=e},t.prototype.setAddress=function(t){this.i=t.i,this.j=t.j},t.prototype.equals=function(t){return null!=t&&this.i==t.i&&this.j==t.j},t}(),Pioneer=function(){function t(t,e){this.walk=0,this.direction=NONE,this.active=!0,this.start=void 0,this.found=void 0,this.boundary=10,this.backward=!1,this.locate=new Address(t,e),this.start=new Address(t,e),null!=map[t][e]?this.walk=map[t][e]:this.walk=0,0<map[t][e]?this.boundary=this.walk*GOLDEN:this.boundary=10,this.route=[],this.active=!0}return t.prototype.move=function(){var t,e;this.direction>NONE&&(t=this.locate.i,e=this.locate.j,this.direction==NORTH?this.locate.i--:this.direction==WEST?this.locate.j--:this.direction==SOUTH?this.locate.i++:this.direction==EAST&&this.locate.j++,this.backward=0<this.route.length&&this.locate.equals(this.route[this.route.length-1]),this.backward?this.route.pop():this.route.push(new Address(t,e)))},t.prototype.goBack=function(){var t;0<this.route.length?(t=this.route[this.route.length-1]).i<this.locate.i?this.direction=NORTH:t.j<this.locate.j?this.direction=WEST:t.i>this.locate.i?this.direction=SOUTH:t.j>this.locate.j?this.direction=EAST:this.direction=NONE:this.direction=NONE},t}(),GOLDEN=1.61807,DEADEND=-2,WALL=-1,WAY=0,NONE=0,NORTH=1,WEST=2,SOUTH=4,EAST=8,shortest=0,n=Number(textWidth.value),m=Number(textHeight.value),improve=!1,w=WIDTH/n,h=HEIGHT/m,maze=new Array(m),map=new Array(m),found=void 0,start=new Address(0,0),finish=new Address(0,0),worker=new Address(0,0),colors=new Array(100),i=0;i<colors.length;i++)colors[i]=rgb(2.5*i,255-2*i,150+i);var points=0,portal=new Array(1),max_point=0,path=new Array(1),teams=[],time=0;function resetMaze(){improve=checkImprove.checked,found=void 0,worker.set(start.i,start.j),path=new Array(0);for(var t=0;t<m;t++)for(var e=0;e<n;e++)maze[t][e]!=WALL&&(maze[t][e]=null),map[t][e]=null;portal[0]=start,max_point=points=1,teams=[new Pioneer(start.i,start.j)],shortest=10}function generateMaze(){return __awaiter(this,void 0,void 0,function(){var e,i,r,a;return __generator(this,function(t){for(n=Number(textWidth.value),m=Number(textHeight.value),w=WIDTH/n,h=HEIGHT/m,maze=new Array(m),map=new Array(m),e=0;e<m;e++)maze[e]=new Array(n),maze[e].fill(WALL),map[e]=new Array(n),map[e].fill(WALL);for(worker.i=1,worker.j=1,i=NORTH,r=0,a=!1,start=new Address(2*Math.floor(m/4)+1,2*Math.floor(n/4)+1),finish=new Address(2*Math.floor(Math.random()*(m-2)/2)+1,2*Math.floor(Math.random()*(n-2)/2)+1),paintMaze();NONE<i;)map[worker.i][worker.j]==WALL?(maze[worker.i][worker.j]=null,map[worker.i][worker.j]=r):r=map[worker.i][worker.j],r++,worker.i%2==1&&worker.j%2==1&&((i=randomDirection(worker))==NONE?(i=goBack(worker),a||(connnectDEADEND(worker,i),a=!0)):a=!1),move(worker,i);return resetMaze(),paintMaze(),[2]})})}function howFarFromFinish(t){return null==found?0:Math.abs(found.i-t.i)+Math.abs(found.j-t.j)}function connnectDEADEND(t,e){1<t.i&&e==SOUTH&&map[t.i-1][t.j]==WALL&&map[t.i][t.j]-map[t.i-2][t.j]>m?maze[t.i-1][t.j]=WAY:1<t.j&&e==EAST&&map[t.i][t.j-1]==WALL&&map[t.i][t.j]-map[t.i][t.j-2]>m?maze[t.i][t.j-1]=WAY:t.i<m-2&&e==NORTH&&map[t.i+1][t.j]==WALL&&map[t.i][t.j]-map[t.i+2][t.j]>n?maze[t.i+1][t.j]=WAY:t.j<n-2&&e==WEST&&map[t.i][t.j+1]==WALL&&map[t.i][t.j]-map[t.i][t.j+2]>n&&(maze[t.i][t.j+1]=WAY)}function solveMaze(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:resetMaze(),cx.clearRect(0,0,WIDTH,HEIGHT),time=0,e=new Pioneer(start.i,start.j),console.time("Solve Maze"),t.label=1;case 1:return 0<points?(time++,[4,explorer(e)]):[3,3];case 2:return t.sent(),[3,1];case 3:return console.timeEnd("Solve Maze"),paintMaze(),paintPath(e.locate),console.log("points="+max_point,"path="+path.length),console.log("time="+time),[2]}})})}function teamSolveMaze(){return __awaiter(this,void 0,void 0,function(){var e,i,r,a;return __generator(this,function(t){switch(t.label){case 0:resetMaze(),cx.clearRect(0,0,WIDTH,HEIGHT),console.time("Team Solve Maze"),time=0,e=1,t.label=1;case 1:if(!(0<points&&0<e))return[3,6];time++,i=e=0,r=teams,t.label=2;case 2:return i<r.length?(a=r[i]).active?(e++,[4,explorer(a)]):[3,4]:[3,5];case 3:t.sent(),t.label=4;case 4:return i++,[3,2];case 5:return[3,1];case 6:return paintMaze(),paintPath(void 0),console.timeEnd("Team Solve Maze"),console.log("points="+max_point,"path="+path.length),console.log("time="+time),[2]}})})}function explorer(n){return __awaiter(this,void 0,void 0,function(){var e,i,r,a;return __generator(this,function(t){switch(t.label){case 0:if(null!=found&&shortest<n.boundary&&(n.boundary=shortest),e=n.locate.i,i=n.locate.j,!n.backward&&(null==map[e][i]||n.walk<map[e][i])?map[e][i]=n.walk:n.walk=map[e][i],map[e][i]==DEADEND?n.goBack():(n.walk++,n.direction=NONE,n.locate.equals(finish)?(found=finish,path=createPath(n.locate),shortest=n.walk-1):n.direction=selectDirection(n.locate)),!(n.direction==NONE||n.walk+howFarFromFinish(n.locate)>n.boundary))return[3,6];if(n.direction!=NONE&&null==found)return[3,4];for(a=0;a<points&&!n.locate.equals(portal[a]);)a++;if(a<points){for(;a<points-1;)portal[a]=portal[a+1],a++;points--}if(!n.locate.equals(n.start))return[3,3];for(n.active=!1,r=0;r<points&&n.walk<map[portal[r].i][portal[r].j];r++)teams[teams.length]=new Pioneer(portal[r].i,portal[r].j);return improve&&null==found?(paintPath(void 0),[4,new Promise(function(t){return setTimeout(t,50)})]):[3,2];case 1:t.sent(),t.label=2;case 2:0<points&&n.walk<map[portal[0].i][portal[0].j]&&(max_point<points&&(max_point=points),improve&&console.log(e,i,"START",points)),0<points&&(n.start=portal[0],n.locate.setAddress(n.start),n.route=[],n.walk=map[n.locate.i][n.locate.j],n.direction=NONE,null==found&&(n.boundary=n.walk*GOLDEN,shortest=n.boundary)),t.label=3;case 3:return[3,5];case 4:if(null==found){for(a=0;a<points&&!n.locate.equals(portal[a]);)a++;a==points&&(portal[points]=new Address(e,i),points++)}else n.active=!1;t.label=5;case 5:0<points&&!n.locate.equals(n.start)&&n.goBack(),t.label=6;case 6:return n.move(),[2]}})})}function createPath(t){var e=new Array(map[t.i][t.j]-1),i=0;e[i++]=new Address(t.i,t.j);for(var r=goBack(t);0<r&&!t.equals(start);)move(t=new Address(t.i,t.j),r),r=goBack(e[i++]=t);return e}function move(t,e){e==NORTH?t.i--:e==WEST?t.j--:e==SOUTH?t.i++:e==EAST&&t.j++}function goBack(t){var e=NONE;return 1<t.i&&isPriorAddress(map[t.i][t.j],map[t.i-1][t.j])?e=NORTH:1<t.j&&isPriorAddress(map[t.i][t.j],map[t.i][t.j-1])?e=WEST:t.i<m-2&&isPriorAddress(map[t.i][t.j],map[t.i+1][t.j])?e=SOUTH:t.j<n-2&&isPriorAddress(map[t.i][t.j],map[t.i][t.j+1])&&(e=EAST),e}function isPriorAddress(t,e){return null!=e&&e!=WALL&&t==e+1}function isNextAddress(t,e,i){return t!=DEADEND&&i!=WALL&&e!=DEADEND&&(null==e||1<e-t)}function isDEADEND(t){var e=0;return(t.i<=1||maze[t.i-1][t.j]==WALL||map[t.i-1][t.j]==DEADEND)&&e++,(t.i>=m-2||maze[t.i+1][t.j]==WALL||map[t.i+1][t.j]==DEADEND)&&e++,(t.j<=1||maze[t.i][t.j-1]==WALL||map[t.i][t.j-1]==DEADEND)&&e++,(t.j>=n-2||maze[t.i][t.j+1]==WALL||map[t.i][t.j+1]==DEADEND)&&e++,3<=e}function randomDirection(t){var e=0,i=0;if(1<t.i&&map[t.i-2][t.j]==WALL&&(e++,i+=NORTH),1<t.j&&map[t.i][t.j-2]==WALL&&(e++,i+=WEST),t.i<m-2&&map[t.i+2][t.j]==WALL&&(e++,i+=SOUTH),t.j<n-2&&map[t.i][t.j+2]==WALL&&(e++,i+=EAST),NONE<e){for(var r=Math.floor(Math.random()*e),e=EAST,a=0;a<r;a++){for(;0==(e&i)&&NONE<e;)e>>=1;e>>=1}for(;0==(e&i)&&NONE<e;)e>>=1}return e}function selectDirection(t){var e=0,i=0;if(1<t.i&&isNextAddress(map[t.i][t.j],map[t.i-1][t.j],maze[t.i-1][t.j])&&(i+=NORTH),1<t.j&&isNextAddress(map[t.i][t.j],map[t.i][t.j-1],maze[t.i][t.j-1])&&(i+=WEST),t.i<m-2&&isNextAddress(map[t.i][t.j],map[t.i+1][t.j],maze[t.i+1][t.j])&&(i+=SOUTH),t.j<n-2&&isNextAddress(map[t.i][t.j],map[t.i][t.j+1],maze[t.i][t.j+1])&&(i+=EAST),NONE<i)for(e=EAST;0==(e&i)&&NONE<e;)e>>=1;return e}function paintPath(t){for(var e,i=1;i<m-1;i++)for(var r=i*h,a=1;a<n-1;a++)null!=map[i][a]&&map[i][a]!=WALL&&(e=a*w,map[i][a]==DEADEND?cx.fillStyle="navy":map[i][a]<=shortest?cx.fillStyle=colors[Math.round(map[i][a]/shortest*(colors.length-1))]:cx.fillStyle="#333333",cx.fillRect(e,r,w-1,h-1));cx.fillStyle="yellow";for(i=0;i<path.length;i++)null!=path[i]&&cx.fillRect(path[i].j*w,path[i].i*h,w-1,h-1);cx.fillStyle="cyan";for(i=0;i<points;i++)cx.fillRect(portal[i].j*w,portal[i].i*h,w-1,h-1);cx.fillStyle=time%2==0?"red":"lime",cx.fillRect((start.j-.5)*w,(start.i-.5)*h,2*w-1,2*h-1),null!=found&&(cx.fillStyle="red",cx.fillRect((found.j-.5)*w,(found.i-.5)*h,2*w-1,2*h-1));for(i=0;i<teams.length;i++)teams[i].active?cx.fillStyle="lime":cx.fillStyle="brown",cx.fillRect(teams[i].locate.j*w,teams[i].locate.i*h,w-1,h-1);null!=t&&(cx.fillStyle="orange",cx.fillRect(t.j*w,t.i*h,w-1,h-1))}function paintMaze(){var t,e;cx.clearRect(0,0,WIDTH,HEIGHT),cx.fillStyle="white";for(var i=1;i<m-1;i++)for(var r=1;r<n-1;r++)maze[i][r]!=WALL&&(t=r*w,e=i*h,cx.fillRect(t,e,w-1,h-1));cx.fillStyle="lime",cx.fillRect((start.j-.5)*w,(start.i-.5)*h,2*w-1,2*h-1),finish.i&&finish.j&&(cx.fillStyle="red",cx.fillRect((finish.j-.5)*w,(finish.i-.5)*h,2*w-1,2*h-1))}function rgb(t,e,i){return(240&t?"#":"#0")+(0==t?"0":"")+(t<<16|e<<8|i).toString(16)}generateMaze();