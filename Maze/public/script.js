for(var __awaiter=this&&this.__awaiter||function(e,o,s,l){return new(s=s||Promise)(function(i,t){function r(e){try{n(l.next(e))}catch(e){t(e)}}function a(e){try{n(l.throw(e))}catch(e){t(e)}}function n(e){var t;e.done?i(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,a)}n((l=l.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(r,a){var n,o,s,l={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(i){return function(e){var t=[i,e];if(n)throw new TypeError("Generator is already executing.");for(;l;)try{if(n=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,(t=s?[2&t[0],s.value]:t)[0]){case 0:case 1:s=t;break;case 4:return l.label++,{value:t[1],done:!1};case 5:l.label++,o=t[1],t=[0];continue;case 7:t=l.ops.pop(),l.trys.pop();continue;default:if(!(s=0<(s=l.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){l=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){l.label=t[1];break}if(6===t[0]&&l.label<s[1]){l.label=s[1],s=t;break}if(s&&l.label<s[2]){l.label=s[2],l.ops.push(t);break}s[2]&&l.ops.pop(),l.trys.pop();continue}t=a.call(r,l)}catch(e){t=[6,e],o=0}finally{n=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},cv=document.getElementById("cpxCanvas"),cx=cv.getContext("2d"),WIDTH=cv.width,HEIGHT=cv.height,size=document.getElementById("size"),checkImprove=document.getElementById("improve"),Address=function(){function e(e,t){this.set(e,t)}return e.prototype.set=function(e,t){this.i=e,this.j=t},e.prototype.setAddress=function(e){this.i=e.i,this.j=e.j},e.prototype.equals=function(e){return null!=e&&this.i==e.i&&this.j==e.j},e}(),Pioneer=function(){function e(e,t){this.walk=0,this.direction=NONE,this.active=!0,this.start=void 0,this.found=void 0,this.boundary=10,this.backward=!1,this.locate=new Address(e,t),this.start=new Address(e,t),null!=map[e][t]?this.walk=map[e][t]:this.walk=0,0<map[e][t]?this.boundary=this.walk*GOLDEN:this.boundary=10,this.route=[],this.active=!0}return e.prototype.move=function(){var e,t;this.direction>NONE&&(e=this.locate.i,t=this.locate.j,this.direction==NORTH?this.locate.i--:this.direction==WEST?this.locate.j--:this.direction==SOUTH?this.locate.i++:this.direction==EAST&&this.locate.j++,this.backward=0<this.route.length&&this.locate.equals(this.route[this.route.length-1]),this.backward?this.route.pop():this.route.push(new Address(e,t)))},e.prototype.goBack=function(){var e;0<this.route.length?(e=this.route[this.route.length-1]).i<this.locate.i?this.direction=NORTH:e.j<this.locate.j?this.direction=WEST:e.i>this.locate.i?this.direction=SOUTH:e.j>this.locate.j?this.direction=EAST:this.direction=NONE:this.direction=NONE},e}(),GOLDEN=1.61807,DEADEND=-2,WALL=-1,WAY=0,NONE=0,NORTH=1,WEST=2,SOUTH=4,EAST=8,shortest=0,n=Number(size.value)+1,m=Number(size.value)+1,improve=!1,w=WIDTH/n,h=HEIGHT/m,maze=new Array(m),map=new Array(m),found=void 0,start=new Address(0,0),finish=new Address(0,0),worker=new Address(0,0),colors=new Array(100),i=0;i<colors.length;i++)colors[i]=rgb(2.5*i,255-2*i,150+i);var points=0,portal=new Array(1),max_point=0,path=new Array(1),teams=[],time=0;function resetMaze(){improve=checkImprove.checked,found=void 0,worker.set(start.i,start.j),path=new Array(0);for(var e=0;e<m;e++)for(var t=0;t<n;t++)maze[e][t]!=WALL&&(maze[e][t]=null),map[e][t]=null;portal[0]=start,max_point=points=1,teams=[new Pioneer(start.i,start.j)],shortest=10}function generateMaze(){return __awaiter(this,void 0,void 0,function(){var t,i,r,a;return __generator(this,function(e){for(n=Number(size.value)+1,m=Number(size.value)+1,w=WIDTH/n,h=HEIGHT/m,maze=new Array(m),map=new Array(m),t=0;t<m;t++)maze[t]=new Array(n),maze[t].fill(WALL),map[t]=new Array(n),map[t].fill(WALL);for(worker.i=1,worker.j=1,i=NORTH,r=0,a=!1,start=new Address(2*Math.floor(m/4)+1,2*Math.floor(n/4)+1),finish=new Address(2*Math.floor(Math.random()*(m-2)/2)+1,2*Math.floor(Math.random()*(n-2)/2)+1),paintMaze();NONE<i;)map[worker.i][worker.j]==WALL?(maze[worker.i][worker.j]=null,map[worker.i][worker.j]=r):r=map[worker.i][worker.j],r++,worker.i%2==1&&worker.j%2==1&&((i=randomDirection(worker))==NONE?(i=goBack(worker),a||(connnectDEADEND(worker,i),a=!0)):a=!1),move(worker,i);return connectMore(),resetMaze(),paintMaze(),[2]})})}function connectMore(){for(var e=2;e<maze.length-2;e+=2)for(var t=2;t<maze.length-2;t+=2)maze[e][t]==WALL&&.9<Math.random()&&(maze[e-1][t]!=WALL&&maze[e+1][t]!=WALL&&maze[e][t-1]==WALL&&maze[e][t+1]==WALL||maze[e][t-1]!=WALL&&maze[e][t+1]!=WALL&&maze[e-1][t]==WALL&&maze[e+1][t]==WALL)&&(maze[e][t]=WAY)}function howFarFromFinish(e){return null==found?0:Math.abs(found.i-e.i)+Math.abs(found.j-e.j)}function connnectDEADEND(e,t){1<e.i&&t==SOUTH&&map[e.i-1][e.j]==WALL&&map[e.i][e.j]-map[e.i-2][e.j]>m?maze[e.i-1][e.j]=WAY:1<e.j&&t==EAST&&map[e.i][e.j-1]==WALL&&map[e.i][e.j]-map[e.i][e.j-2]>m?maze[e.i][e.j-1]=WAY:e.i<m-2&&t==NORTH&&map[e.i+1][e.j]==WALL&&map[e.i][e.j]-map[e.i+2][e.j]>n?maze[e.i+1][e.j]=WAY:e.j<n-2&&t==WEST&&map[e.i][e.j+1]==WALL&&map[e.i][e.j]-map[e.i][e.j+2]>n&&(maze[e.i][e.j+1]=WAY)}function solveMaze(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:resetMaze(),cx.clearRect(0,0,WIDTH,HEIGHT),time=0,t=new Pioneer(start.i,start.j),console.time("Solve Maze"),e.label=1;case 1:return 0<points?(time++,[4,explorer(t)]):[3,3];case 2:return e.sent(),[3,1];case 3:return console.timeEnd("Solve Maze"),paintMaze(),paintPath(t.locate),console.log("points="+max_point,"path="+path.length),console.log("time="+time),[2]}})})}function teamSolveMaze(){return __awaiter(this,void 0,void 0,function(){var t,i,r,a;return __generator(this,function(e){switch(e.label){case 0:resetMaze(),cx.clearRect(0,0,WIDTH,HEIGHT),console.time("Team Solve Maze"),time=0,t=1,e.label=1;case 1:if(!(0<points&&0<t))return[3,6];time++,i=t=0,r=teams,e.label=2;case 2:return i<r.length?(a=r[i]).active?(t++,[4,explorer(a)]):[3,4]:[3,5];case 3:e.sent(),e.label=4;case 4:return i++,[3,2];case 5:return[3,1];case 6:return paintMaze(),paintPath(void 0),console.timeEnd("Team Solve Maze"),console.log("points="+max_point,"path="+path.length),console.log("time="+time),[2]}})})}function explorer(n){return __awaiter(this,void 0,void 0,function(){var t,i,r,a;return __generator(this,function(e){switch(e.label){case 0:if(null!=found&&shortest<n.boundary&&(n.boundary=shortest),t=n.locate.i,i=n.locate.j,!n.backward&&(null==map[t][i]||n.walk<map[t][i])?map[t][i]=n.walk:n.walk=map[t][i],map[t][i]==DEADEND?n.goBack():(n.walk++,n.direction=NONE,n.locate.equals(finish)?(found=finish,path=createPath(n.locate),shortest=n.walk-1):n.direction=selectDirection(n.locate)),!(n.direction==NONE||n.walk+howFarFromFinish(n.locate)>n.boundary))return[3,6];if(n.direction!=NONE&&null==found)return[3,4];for(a=0;a<points&&!n.locate.equals(portal[a]);)a++;if(a<points){for(;a<points-1;)portal[a]=portal[a+1],a++;points--}if(!n.locate.equals(n.start))return[3,3];for(n.active=!1,r=0;r<points&&n.walk<map[portal[r].i][portal[r].j];r++)teams[teams.length]=new Pioneer(portal[r].i,portal[r].j);return improve&&null==found?(paintPath(void 0),[4,new Promise(function(e){return setTimeout(e,50)})]):[3,2];case 1:e.sent(),e.label=2;case 2:0<points&&n.walk<map[portal[0].i][portal[0].j]&&(max_point<points&&(max_point=points),improve&&console.log(t,i,"START",points)),0<points&&(n.start=portal[0],n.locate.setAddress(n.start),n.route=[],n.walk=map[n.locate.i][n.locate.j],n.direction=NONE,null==found&&(n.boundary=n.walk*GOLDEN,shortest=n.boundary)),e.label=3;case 3:return[3,5];case 4:if(null==found){for(a=0;a<points&&!n.locate.equals(portal[a]);)a++;a==points&&(portal[points]=new Address(t,i),points++)}else n.active=!1;e.label=5;case 5:0<points&&!n.locate.equals(n.start)&&n.goBack(),e.label=6;case 6:return n.move(),[2]}})})}function createPath(e){for(var t=new Array(map[e.i][e.j]-1),i=0,r=(t[i++]=new Address(e.i,e.j),goBack(e));0<r&&!e.equals(start);)move(e=new Address(e.i,e.j),r),r=goBack(t[i++]=e);return t}function move(e,t){t==NORTH?e.i--:t==WEST?e.j--:t==SOUTH?e.i++:t==EAST&&e.j++}function goBack(e){var t=NONE;return 1<e.i&&isPriorAddress(map[e.i][e.j],map[e.i-1][e.j])?t=NORTH:1<e.j&&isPriorAddress(map[e.i][e.j],map[e.i][e.j-1])?t=WEST:e.i<m-2&&isPriorAddress(map[e.i][e.j],map[e.i+1][e.j])?t=SOUTH:e.j<n-2&&isPriorAddress(map[e.i][e.j],map[e.i][e.j+1])&&(t=EAST),t}function isPriorAddress(e,t){return null!=t&&t!=WALL&&e==t+1}function isNextAddress(e,t,i){return e!=DEADEND&&i!=WALL&&t!=DEADEND&&(null==t||1<t-e)}function isDEADEND(e){var t=0;return(e.i<=1||maze[e.i-1][e.j]==WALL||map[e.i-1][e.j]==DEADEND)&&t++,(e.i>=m-2||maze[e.i+1][e.j]==WALL||map[e.i+1][e.j]==DEADEND)&&t++,(e.j<=1||maze[e.i][e.j-1]==WALL||map[e.i][e.j-1]==DEADEND)&&t++,(e.j>=n-2||maze[e.i][e.j+1]==WALL||map[e.i][e.j+1]==DEADEND)&&t++,3<=t}function randomDirection(e){var t=0,i=0;if(1<e.i&&map[e.i-2][e.j]==WALL&&(t++,i+=NORTH),1<e.j&&map[e.i][e.j-2]==WALL&&(t++,i+=WEST),e.i<m-2&&map[e.i+2][e.j]==WALL&&(t++,i+=SOUTH),e.j<n-2&&map[e.i][e.j+2]==WALL&&(t++,i+=EAST),NONE<t){for(var r=Math.floor(Math.random()*t),t=EAST,a=0;a<r;a++){for(;0==(t&i)&&NONE<t;)t>>=1;t>>=1}for(;0==(t&i)&&NONE<t;)t>>=1}return t}function selectDirection(e){var t=0,i=0;if(1<e.i&&isNextAddress(map[e.i][e.j],map[e.i-1][e.j],maze[e.i-1][e.j])&&(i+=NORTH),1<e.j&&isNextAddress(map[e.i][e.j],map[e.i][e.j-1],maze[e.i][e.j-1])&&(i+=WEST),e.i<m-2&&isNextAddress(map[e.i][e.j],map[e.i+1][e.j],maze[e.i+1][e.j])&&(i+=SOUTH),e.j<n-2&&isNextAddress(map[e.i][e.j],map[e.i][e.j+1],maze[e.i][e.j+1])&&(i+=EAST),NONE<i)for(t=EAST;0==(t&i)&&NONE<t;)t>>=1;return t}function paintPath(e){for(var t,i=1;i<m-1;i++)for(var r=i*h,a=1;a<n-1;a++)null!=map[i][a]&&map[i][a]!=WALL&&(t=a*w,map[i][a]==DEADEND?cx.fillStyle="navy":map[i][a]<=shortest?cx.fillStyle=colors[Math.round(map[i][a]/shortest*(colors.length-1))]:cx.fillStyle="#333333",cx.fillRect(t,r,w-1,h-1));cx.fillStyle="yellow";for(i=0;i<path.length;i++)null!=path[i]&&cx.fillRect(path[i].j*w,path[i].i*h,w-1,h-1);cx.fillStyle="cyan";for(i=0;i<points;i++)cx.fillRect(portal[i].j*w,portal[i].i*h,w-1,h-1);cx.fillStyle=time%2==0?"red":"lime",cx.fillRect((start.j-.5)*w,(start.i-.5)*h,2*w-1,2*h-1),null!=found&&(cx.fillStyle="red",cx.fillRect((found.j-.5)*w,(found.i-.5)*h,2*w-1,2*h-1));for(i=0;i<teams.length;i++)teams[i].active?cx.fillStyle="lime":cx.fillStyle="brown",cx.fillRect(teams[i].locate.j*w,teams[i].locate.i*h,w-1,h-1);null!=e&&(cx.fillStyle="orange",cx.fillRect(e.j*w,e.i*h,w-1,h-1))}function paintMaze(){var e,t;cx.clearRect(0,0,WIDTH,HEIGHT),cx.fillStyle="white";for(var i=1;i<m-1;i++)for(var r=1;r<n-1;r++)maze[i][r]!=WALL&&(e=r*w,t=i*h,cx.fillRect(e,t,w-1,h-1));cx.fillStyle="lime",cx.fillRect((start.j-.5)*w,(start.i-.5)*h,2*w-1,2*h-1),finish.i&&finish.j&&(cx.fillStyle="red",cx.fillRect((finish.j-.5)*w,(finish.i-.5)*h,2*w-1,2*h-1))}function rgb(e,t,i){return(240&e?"#":"#0")+(0==e?"0":"")+(e<<16|t<<8|i).toString(16)}generateMaze();